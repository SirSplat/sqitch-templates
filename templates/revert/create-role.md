# Usage Documentation for Revert Template (`revert/create-role.sql.tt2`)

This document provides detailed usage instructions for the **revert** template used with the `create-role.sql.tt2` Sqitch change. The **revert** template is essential for safely rolling back a role creation in PostgreSQL.

## Template Overview

The `revert` template is used to remove a role from the PostgreSQL database. This ensures that any role created by the **deploy** template can be safely removed when rolling back a change.

See PostgreSQL documentation for [DROP ROLE](https://www.postgresql.org/docs/current/sql-droprole.html) implementation.

## Template Structure

```sql
/* Generated by: ~/.sqitch/templates/revert/create-role.tmpl */

-- Revert [% project %]:[% change %] from [% engine %]

BEGIN;

DROP ROLE [% rolename %];

COMMIT;
```

## Parameter Explanation

- **`[% rolename %]`**: The name of the role to be dropped. This parameter must be set to ensure that the correct role is removed during the rollback.

## How It Works

- **BEGIN;** and **COMMIT;**: The `BEGIN;` and `COMMIT;` statements ensure that the `DROP ROLE` operation is executed within a transaction block. This guarantees atomicityâ€”if the `DROP ROLE` statement fails for any reason, the transaction will be rolled back to maintain the database state.
- **DROP ROLE**: This command drops the specified role from the database. It will throw an error if the role does not exist, highlighting potential discrepancies in the database state.

## Usage Scenarios

### Example 1: Basic Revert of a Role

**Command**:
```bash
sqitch revert create_admin_user
```

**Generated SQL**:
```sql
/* Generated by: ~/.sqitch/templates/revert/create-role.tmpl */

-- Revert my_project:create_admin_user from PostgreSQL

BEGIN;

DROP ROLE admin_user;

COMMIT;
```

**Explanation**: This command reverts the `admin_user` role by dropping it from the database.

## Best Practices

- **Ensure No Dependencies**: Before running the `revert` operation, make sure the role does not own any objects or have dependent permissions. If the role has dependencies, `DROP ROLE` will fail unless those dependencies are addressed.
- **Test in Development**: Run the `revert` operation in a development environment to confirm that it behaves as expected before applying it to production.
- **Backup**: Always have a backup of your database or configuration before running the `revert` command to safeguard against unexpected changes.

## Common Errors

- **Dependent Objects**: The `DROP ROLE` command will fail if the role owns objects or has dependent privileges. Ensure that any dependent objects or permissions are reassigned or removed before running the `revert`.
- **Non-Existent Role**: The `DROP ROLE` command will fail if the role does not exist. Be prepared to handle this error gracefully or ensure the role's existence before running the revert.

## Conclusion

The **revert** template for `CREATE ROLE` is a crucial part of managing database roles in a **Sqitch** project. It ensures that roles can be safely removed, maintaining consistency and stability in your PostgreSQL environment. Follow best practices to handle dependencies and test your changes in a safe environment before applying them to production.
