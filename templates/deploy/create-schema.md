# Usage Document for `create-schema.tmpl` Template

This document provides detailed information on using the `create-schema.tmpl` template for deploying schema changes in a PostgreSQL database with **Sqitch**. The template generates SQL for creating a schema and adding an optional comment.

## Template Overview

The `create-schema.tmpl` template is designed to deploy a new schema in PostgreSQL and optionally add a comment to it. It supports the following features:

- **Schema Creation**: Creates a new schema in the specified database.
- **Comments**: Adds a comment to the schema or sets it to `NULL` if no comment is provided.
- **Dependencies and Conflicts**: Lists dependencies (`requires`) and conflicts (`conflicts`) as comments for better documentation.

See PostgreSQL documentation for [CREATE SCHEMA](https://www.postgresql.org/docs/current/sql-createschema.html) implementation.
See PostgreSQL documentation for [COMMENT ON SCHEMA](https://www.postgresql.org/docs/current/sql-comment.html) implementation.

## Template Parameters

1. **`project`**: The name of the project deploying the schema. Gathered from sqitch.conf.
2. **`change`**: The name of the specific change being deployed. Gathered from sqitch.conf.
3. **`engine`**: The database engine being used (e.g., PostgreSQL). Gathered from sqitch.conf.
4. **`requires`**: (Optional) A list of dependencies required by this change.
5. **`conflicts`**: (Optional) A list of changes that conflict with this change.
6. **`schemaname`**: The name of the schema to be created.
7. **`schemacomment`**: (Optional) A comment for the schema. If not provided, the comment is set to `NULL`.

## Template Logic

- The `BEGIN;` and `COMMIT;` statements ensure that the schema creation is executed within a transaction.
- The `CREATE SCHEMA` statement creates the schema specified by `[% schemaname %]`.
- The `COMMENT ON SCHEMA` statement adds a comment if `[% schemacomment %]` is provided. If not, the comment is set to `NULL`.

## Template Structure

```sql
/* Generated by: ~/.sqitch/templates/deploy/create-schema.tmpl */

-- Deploy [% project %]:[% change %] to [% engine %]
[% FOREACH item IN requires -%]
-- requires: [% item %]
[% END -%]
[% FOREACH item IN conflicts -%]
-- conflicts: [% item %]
[% END -%]

BEGIN;

CREATE SCHEMA [% schemaname %];
COMMENT ON SCHEMA [% schemaname %] IS [% IF schemacomment %]'[% schemacomment %]'[% ELSE %]NULL[% END %];

COMMIT;
```

## Detailed Parameter Explanation

- **`[% schemaname %]`**: This parameter must be set to the name of the schema to be created.
- **`[% schemacomment %]`**: If provided, this will be used as the comment for the schema. If not provided, the comment is set to `NULL`.
- **`requires` and `conflicts`**: These are not part of the actual SQL logic but are used to document dependencies and potential conflicts for better understanding and tracking.

# Example Usage Scenarios

For sqitch [add options syntax](https://sqitch.org/docs/manual/sqitch-add/)

## Example 1: Basic Schema Creation with a Comment

**Command**:
```bash
sqitch add create_appschema db --template create-schema \
    -s schemaname=appschema \
    -s schemacomment='Home of all things appschema.' \
    -m 'Add application schema.'
```

**Generated SQL**:
```sql
/* Generated by: ~/.sqitch/templates/deploy/create-schema.tmpl */

-- Deploy my_project:create_appschema to pg

BEGIN;

CREATE SCHEMA appschema;
COMMENT ON SCHEMA appschema IS 'Home of all things appschema.';

COMMIT;
```

## Example 2: Schema Creation with Dependencies

**Command**:
```bash
sqitch add create_appschema db --template create-schema \
    -r importschema \
    -s schemaname=appschema \
    -s schemacomment='Home of all things appschema.' \
    -m 'Add application schema.'
```

**Generated SQL**:
```sql
/* Generated by: ~/.sqitch/templates/deploy/create-schema.tmpl */

-- Deploy my_project:create_appschema to pg
-- requires: importschema

BEGIN;

CREATE SCHEMA appschema;
COMMENT ON SCHEMA appschema IS 'Home of all things appschema.';

COMMIT;
```

## Example 3: Schema Creation with Conflicts

**Command**:
```bash
sqitch add create_appschema db --template create-schema \
    -c archiveschema \
    -s schemaname=appschema \
    -s schemacomment='Home of all things appschema.' \
    -m 'Add application schema.'
```

**Generated SQL**:
```sql
/* Generated by: ~/.sqitch/templates/deploy/create-schema.tmpl */

-- Deploy my_project:create_appschema to pg
-- conflicts: archiveschema

BEGIN;

CREATE SCHEMA appschema;
COMMENT ON SCHEMA appschema IS 'Home of all things appschema.';

COMMIT;
```

## Example 4: Comprehensive Example with Both Dependencies and Conflicts

**Command**:
```bash
sqitch add create_appschema db --template create-schema \
    -r importschema \
    -c archiveschema \
    -s schemaname=appschema \
    -s schemacomment='Home of all things appschema.' \
    -m 'Add application schema.'
```

**Generated SQL**:
```sql
/* Generated by: ~/.sqitch/templates/deploy/create-schema.tmpl */

-- Deploy my_project:create_appschema to PostgreSQL
-- requires: importschema
-- conflicts: archiveschema

BEGIN;

CREATE SCHEMA appschema;
COMMENT ON SCHEMA appschema IS 'Home of all things appschema.';

COMMIT;
```

# Notes

- **Enforcing Comments**: In this template, the `COMMENT ON SCHEMA` statement is mandatory, ensuring that every schema has a provided comment. A `NULL` indicates the lack of a comment, which will cause the verify to error and rollback the migration!
- **Dependencies and Conflicts**: The `requires` and `conflicts` parameters are not part of the actual SQL execution but are used for documentation purposes within **Sqitch**. **Sqitch** will check the projects plan file to ensure these are present or not.
- **Flexibility**: Adjust the `schemaname` and `schemacomment` as needed for different use cases.

# Conclusion

This `create-schema.tmpl` template is a simple yet powerful way to create schemas and document them effectively in a **Sqitch** project. The examples provided show how to handle different scenarios, including adding comments, specifying dependencies and conflicts.
