# Usage Documentation for Deploy Template (`deploy/create-role.sql`)

This document provides detailed usage instructions for the **deploy** template used with the `create-role.sql` Sqitch change. The **deploy** template is essential for creating a new role in PostgreSQL with a variety of configuration options.

## Template Overview

The `deploy` template is used to create a role in PostgreSQL with various options such as login privileges, password, and connection limits. It provides flexibility in setting the attributes of the role during creation.

It is mandatory to provide a comment for the role, the verify will throw an error if no comment is provided.

See PostgreSQL documentation for [CREATE ROLE](https://www.postgresql.org/docs/current/sql-createrole.html) implementation.
See PostgreSQL documentation for [COMMENT ON ROLE](https://www.postgresql.org/docs/current/sql-comment.html) implementation.

## Template Structure

```sql
/* Generated by: ~/.sqitch/templates/deploy/create-role.tmpl */

-- Deploy [% project %]:[% change %] to [% engine %]

CREATE ROLE [% rolename %] WITH
[% IF superuser %]    SUPERUSER [% ELSE %]    NOSUPERUSER [% END %]
[% IF createdb %]    CREATEDB[% ELSE %]    NOCREATEDB[% END %]
[% IF createrole %]    CREATEROLE[% ELSE %]    NOCREATEROLE[% END %]
[% IF inherit %]    INHERIT[% ELSE %]    NOINHERIT[% END %]
[% IF login %]    LOGIN[% ELSE %]    NOLOGIN[% END %]
[% IF replication %]    REPLICATION[% ELSE %]    NOREPLICATION[% END %]
[% IF bypassrls %]    BYPASSRLS[% ELSE %]    NOBYPASSRLS[% END -%]
[% IF connlimit %]    CONNECTION LIMIT [% connlimit %][% END -%]
[% IF login && password %]    PASSWORD '[% password %]'[% END -%]
[% IF validuntil %]    VALID UNTIL '[% validuntil %]'[% END -%]
[% IF inrole %]    IN ROLE [% inrole.join(', ') %][% END -%]
[% IF role %]    ROLE [% role.join(', ') %][% END -%]
[% IF admin %]    ADMIN [% admin.join(', ') %][% END -%]
[% IF sysid %]    SYSID [% sysid %][% END -%];
```

## Parameter Explanation

- **`[% rolename %]`**: The name of the role to be created.
- **`superuser`**: Specifies if the role is a superuser (`SUPERUSER` or `NOSUPERUSER`).
- **`createdb`**: Determines if the role can create databases (`CREATEDB` or `NOCREATEDB`).
- **`createrole`**: Specifies if the role can create other roles (`CREATEROLE` or `NOCREATEROLE`).
- **`inherit`**: Indicates if the role can inherit privileges (`INHERIT` or `NOINHERIT`).
- **`login`**: Specifies if the role can log in (`LOGIN` or `NOLOGIN`).
- **`replication`**: Specifies if the role has replication privileges (`REPLICATION` or `NOREPLICATION`).
- **`bypassrls`**: Determines if the role can bypass row-level security (`BYPASSRLS` or `NOBYPASSRLS`).
- **`connlimit`**: Sets the connection limit for the role (`CONNECTION LIMIT`).
- **`password`**: Sets an encrypted password if both `login` and `password` are provided.
- **`validuntil`**: Specifies when the role expires (`VALID UNTIL`).
- **`inrole`**: Specifies roles that this role is a member of (`IN ROLE`).
- **`role`**: Specifies roles that this role can grant (`ROLE`).
- **`admin`**: Specifies roles for which this role has administrative rights (`ADMIN`).
- **`sysid`**: Sets a system ID for the role (`SYSID`).

## How It Works

- The template uses **Template Toolkit 2 (TT2)** syntax to conditionally include or exclude SQL options based on the parameters provided during the execution of the template.
- The `CREATE ROLE` statement is configured to include all specified options, allowing for full customization of the role attributes.

## Usage Scenarios

For sqitch options syntax see: https://sqitch.org/docs/manual/sqitch-add/

### Example 1: Create a Basic Role with Login, Password and a Comment

**Command**:
```bash
sqitch add create_basic_role db --template create-role \
    -s rolename=user_role \
    -s login=1 \
    -s rolecomment='Basic role, used by monitoring tools.' \
    -s password=my_password
```

**Generated SQL**:
```sql
CREATE ROLE user_role WITH
    NOSUPERUSER
    NOCREATEDB
    NOCREATEROLE
    NOINHERIT
    LOGIN
    NOREPLICATION
    NOBYPASSRLS
    PASSWORD 'my_password';
```

**Explanation**: This command creates a role named `user_role` with login privileges and a password.

### Example 2: Create a Superuser Role

**Command**:
```bash
sqitch add create_superuser_role --template create-role \
    -s rolename=admin_user \
    -s superuser=1
```

**Generated SQL**:
```sql
CREATE ROLE admin_user WITH
    SUPERUSER
    NOCREATEDB
    NOCREATEROLE
    NOINHERIT
    NOLOGIN
    NOREPLICATION
    NOBYPASSRLS;
```

**Explanation**: This command creates a role named `admin_user` with superuser privileges.

### Example 3: Create a Role with Connection Limits and Expiry

**Command**:
```bash
sqitch add create_limited_role --template create-role \
    -s rolename=limited_user \
    -s connlimit=5 \
    -s validuntil='2025-12-31 23:59:59'
```

**Generated SQL**:
```sql
CREATE ROLE limited_user WITH
    NOSUPERUSER
    NOCREATEDB
    NOCREATEROLE
    NOINHERIT
    NOLOGIN
    NOREPLICATION
    NOBYPASSRLS
    CONNECTION LIMIT 5
    VALID UNTIL '2025-12-31 23:59:59';
```

**Explanation**: This command creates a role named `limited_user` with a connection limit of 5 and an expiration date.

### Example 4: Create a Role with Memberships and Administrative Rights

**Command**:
```bash
sqitch add create_role_with_admin_rights --template create-role \
    -s rolename=project_lead \
    -s admin=['developer', 'tester']
```

**Generated SQL**:
```sql
CREATE ROLE project_lead WITH
    NOSUPERUSER
    NOCREATEDB
    NOCREATEROLE
    NOINHERIT
    NOLOGIN
    NOREPLICATION
    NOBYPASSRLS
    ADMIN developer, tester;
```

**Explanation**: This command creates a role named `project_lead` with administrative rights over the `developer` and `tester` roles.

### Example 5: Create a Role with Custom System ID

**Command**:
```bash
sqitch add create_custom_sysid_role --template create-role \
    -s rolename=custom_role \
    -s sysid=1001
```

**Generated SQL**:
```sql
CREATE ROLE custom_role WITH
    NOSUPERUSER
    NOCREATEDB
    NOCREATEROLE
    NOINHERIT
    NOLOGIN
    NOREPLICATION
    NOBYPASSRLS
    SYSID 1001;
```

**Explanation**: This command creates a role named `custom_role` with a custom system ID of 1001.

## Best Practices

- **Secure Passwords**: Ensure that passwords are encrypted and securely managed.
- **Limit Privileges**: Assign only the necessary privileges to roles to follow the principle of least privilege.
- **Document Roles**: Maintain clear documentation on the purpose and attributes of each role for better management and auditing.

## Conclusion

The **deploy** template for `CREATE ROLE` is a powerful tool for defining roles in PostgreSQL with a variety of options. It allows for complete customization and ensures consistency in role creation across different environments.
