/* Generated by: ~/.sqitch/templates/deploy/create-table.tmpl */

-- Deploy [% project %]:[% change %] to [% engine %]
[% FOREACH item IN requires -%]
-- requires: [% item %]
[% END -%]
[% FOREACH item IN conflicts -%]
-- conflicts: [% item %]
[% END -%]

BEGIN;

CREATE TABLE [% schemaname %].[% tablename %][% IF partitionofschemaname %] PARTITION OF [% partitionofschemaname %].[% partitionoftablename %][% IF partitionofvalues %]FOR VALUES IN ( [% partitionofvalues %] )[% ELSE %] DEFAULT[% END %][% ELSE %] ([% END -%]

[% FOREACH item IN columnname -%]
    [% item %] [% IF columntype.item( loop.index ) == 'IDENTITY' %]BIGINT NOT NULL GENERATED ALWAYS AS IDENTITY[% ELSE %][% columntype.item( loop.index ) %][% END %],
[% END -%]
[% IF partitionofschemaname %][% ELSE %]    LIKE rental.audit_columns INCLUDING DEFAULTS INCLUDING COMMENTS[% IF tableconstraint %],[% END %][% END %]
[%- FOREACH item IN tableconstraint %]
    [%- IF constrainttype.item( loop.index ) == 'FOREIGN KEY' %]
    CONSTRAINT [% item %] [% constrainttype.item( loop.index ) %] [% constraintdefinition.item( loop.index ) %] DEFERRABLE INITIALLY IMMEDIATE[% loop.last ? '' : ', ' %]
    [%- ELSE %]
    CONSTRAINT [% item %] [% constrainttype.item( loop.index ) %] ( [% constraintdefinition.item( loop.index ) %] )[% loop.last ? '' : ', ' %]
    [%- END %]
[%- END %]
[% IF partitiontype %]) PARTITION BY [% partitiontype %] ( [% partitiondefinition %] ); [% ELSIF partitionofschemaname %];[% ELSE %]);[% END %]

[% IF tablecomment -%]COMMENT ON TABLE [% schemaname %].[% tablename %] IS '[% tablecomment %]';[% END %]

[% IF columnname %][% FOREACH item IN columnname -%]
COMMENT ON COLUMN [% schemaname %].[% tablename %].[% item %] IS '[% columncomment.item( loop.index ) %]';
[% END -%][% END -%]

[% IF tableconstraint %][% FOREACH item IN tableconstraint -%]
COMMENT ON CONSTRAINT [% item %] ON [% schemaname %].[% tablename %] IS '[% constraintcomment.item( loop.index ) %]';
[% END -%][% END -%]

COMMIT;