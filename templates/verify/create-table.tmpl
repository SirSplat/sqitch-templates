/* Generated by: ~/.sqitch/templates/verify/create-table.tmpl */

-- Verify [% project %]:[% change %] on [% engine %]

BEGIN;

/* Test table exists in the correct schema */
SELECT
    1 / COUNT( tables.table_name )
FROM
    information_schema.tables
WHERE
    tables.table_schema = '[% schemaname %]' AND
    tables.table_name = '[% tablename %]';

/* Test table has a comment */
SELECT
    1 / COUNT( pg_catalog.obj_description( pg_class.oid, 'pg_class' ) )
FROM
    pg_catalog.pg_class
    JOIN pg_catalog.pg_namespace ON (
        pg_namespace.oid = pg_class.relnamespace AND
        pg_namespace.nspname = '[% schemaname %]'
    )
WHERE
    pg_class.relname = '[% tablename %]';

/* Test each column has a comment */
[% FOREACH item IN columnname %]
SELECT
    1 / COUNT( pg_catalog.col_description( pg_class.oid, pg_attribute.attnum ) )
FROM
    pg_catalog.pg_class
    JOIN pg_catalog.pg_namespace ON (
        pg_namespace.oid = pg_class.relnamespace AND
        pg_namespace.nspname = '[% schemaname %]'
    )
    JOIN pg_catalog.pg_attribute ON (
        pg_attribute.attrelid = pg_class.oid AND
        pg_attribute.attnum > 0 AND
        pg_attribute.attname = '[% item %]'
    )
WHERE
    pg_class.relname = '[% tablename %]';
[% END %]

/* Test that each constraint has a comment */
[% FOREACH item IN tableconstraint %]
SELECT
    pg_catalog.obj_description( pg_constraint.oid, 'pg_constraint' )
FROM
    pg_catalog.pg_class
    JOIN pg_catalog.pg_namespace ON (
        pg_namespace.oid = pg_class.relnamespace AND
        pg_namespace.nspname = '[% schemaname %]'
    )
    JOIN pg_catalog.pg_constraint ON (
        pg_constraint.conrelid = pg_class.oid AND
        pg_constraint.connamespace = pg_namespace.oid AND
        pg_constraint.conname = '[% item %]'
    )
WHERE
    pg_class.relname = '[% tablename %]';
[% END %]

COMMIT;