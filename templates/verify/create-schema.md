# Usage Documentation for Verify Template (`verify/create-schema.tmpl`)

This document provides detailed usage instructions for the **verify** template used with the `create-schema.tmpl` Sqitch change. The **verify** template ensures that a schema deployed to a PostgreSQL database exists and meets specific criteria, such as ownership and having a comment.

## Template Overview

The `verify` template is used to check the existence of a schema, confirm its ownership by a specific role, and verify that it has an associated comment. This operation ensures that the schema was created correctly according to the expectations defined during deployment.

## Template Structure

```sql
/* Generated by: ~/.sqitch/templates/verify/create-schema.tmpl */

-- Verify [% project %]:[% change %] on [% engine %]

BEGIN;

-- Ensure the schema exists.
SELECT pg_catalog.has_schema_privilege('dbo', '[% schemaname %]', 'USAGE');

-- Ensure the dbo role is the owner of the schema.
SELECT
    1 / COUNT(pg_roles.rolname)
FROM
    pg_catalog.pg_namespace
    JOIN pg_catalog.pg_roles ON (
        pg_roles.oid = pg_namespace.nspowner AND
        pg_roles.rolname = 'dbo'
    )
WHERE
    pg_namespace.nspname = '[% schemaname %]';

-- Ensure the schema has a comment provided.
SELECT
    1 / COUNT(pg_catalog.obj_description(pg_namespace.oid, 'pg_namespace'))
FROM
    pg_catalog.pg_namespace
WHERE
    pg_namespace.nspname = '[% schemaname %]';

COMMIT;
```

## Parameter Explanation

- **`[% schemaname %]`**: The name of the schema to be verified. This parameter is provided when running the `sqitch add` with the create-schema template.

## How It Works

- **BEGIN;** and **COMMIT;**: These statements ensure that the verification operation is executed within a transaction block. This allows the checks to be consistent and ensures atomic execution.
- **Schema Existence Check**: The `pg_catalog.has_schema_privilege` function is used to confirm that the `dbo` role has `USAGE` privileges on the schema, indicating its existence.
- **Ownership Check**: A query using `COUNT` verifies that the `dbo` role owns the schema. If the count is `0`, a division by zero error is triggered, indicating that the schema is not owned by the `dbo` role.
- **Comment Check**: A query using `COUNT` checks if the schema has an associated comment. If there is no comment, a division by zero error will occur, enforcing the requirement for a comment.

## Usage Scenarios

### Example 1: Basic Verification of a Schema

**Command**:
```bash
sqitch verify db
```

**Generated SQL**:
```sql
/* Generated by: ~/.sqitch/templates/verify/create-schema.tmpl */

-- Verify my_project:create_appschema on PostgreSQL

BEGIN;

-- Ensure the schema exists.
SELECT pg_catalog.has_schema_privilege('dbo', 'appschema', 'USAGE');

-- Ensure the dbo role is the owner of the schema.
SELECT
    1 / COUNT(pg_roles.rolname)
FROM
    pg_catalog.pg_namespace
    JOIN pg_catalog.pg_roles ON (
        pg_roles.oid = pg_namespace.nspowner AND
        pg_roles.rolname = 'dbo'
    )
WHERE
    pg_namespace.nspname = 'appschema';

-- Ensure the schema has a comment provided.
SELECT
    1 / COUNT(pg_catalog.obj_description(pg_namespace.oid, 'pg_namespace'))
FROM
    pg_catalog.pg_namespace
WHERE
    pg_namespace.nspname = 'appschema';

COMMIT;
```

**Explanation**: This command verifies that the `appschema` schema exists, is owned by the `dbo` role, and has an associated comment.

## Best Practices

- **Run Verification Regularly**: Run the `verify` operation after deploying or reverting changes to ensure the database state matches the expected schema structure.
- **Error Handling**: The `verify` template is designed to fail if any of the checks are not met (e.g., the schema is not owned by the expected role or lacks a comment). This helps maintain the integrity of the database and highlights discrepancies.

## Common Errors

- **Schema Not Found**: If the schema does not exist, the `pg_catalog.has_schema_privilege` check will fail.
- **Incorrect Ownership**: If the `dbo` role is not the owner, the `COUNT` query will result in a division by zero error, indicating a failed ownership check.
- **Missing Comment**: If no comment is associated with the schema, the comment check will fail due to a division by zero error. This ensures that all schemas are documented with a comment.

## Conclusion

The **verify** template is an essential part of a **Sqitch** project, ensuring that the deployed schema meets specific criteria such as existence, ownership, and having a comment. This helps maintain a consistent and verified database structure. Follow best practices to run verification checks and handle any discrepancies proactively.
