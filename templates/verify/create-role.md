# Usage Documentation for Verify Template (`verify/create-role.sql.tt2`)

This document provides detailed usage instructions for the **verify** template used with the `create-role.sql.tt2` Sqitch change. The **verify** template is essential for confirming that a role has been created and has an associated comment in PostgreSQL.

## Template Overview

The `verify` template checks if the specified role exists in the database and verifies that a comment is provided for it.

See PostgreSQL documentation for [pg_catalog.pg_roles](https://www.postgresql.org/docs/current/view-pg-roles.html) implementation.
See PostgreSQL documentation for [pg_catalog.shobj_description](https://www.postgresql.org/docs/current/functions-info.html#FUNCTIONS-INFO-COMMENT-TABLE) implementation.

## Template Structure

```sql
/* Generated by: ~/.sqitch/templates/verify/create-role.tmpl */

-- Verify [% project %]:[% change %] on [% engine %]

BEGIN;

-- Check if the role exists.
SELECT 1 / COUNT(*)
FROM pg_catalog.pg_roles
WHERE rolname = '[% rolename %]';

-- Ensure the role has a comment provided.
SELECT 1 / COUNT(pg_catalog.shobj_description(pg_roles.oid, 'pg_authid'))
FROM pg_catalog.pg_roles
WHERE rolname = '[% rolename %]';

COMMIT;
```

## Parameter Explanation

- **`[% rolename %]`**: The name of the role to be verified. This parameter must be set to ensure that the verification checks the correct role.

## How It Works

- **BEGIN;** and **COMMIT;**: These statements ensure that the verification is executed within a transaction block, making it atomic.
- **Role Existence Check**: The `SELECT 1 / COUNT(*)` query verifies if the role exists. If the count is `0`, a division by zero occurs, resulting in an error that signals the role was not found.
- **Comment Check**: The `SELECT 1 / COUNT(pg_catalog.shobj_description(...))` query ensures that a comment is associated with the role. If there is no comment, the count returns `0`, causing a division by zero error and indicating that the role lacks a comment.

## Usage Scenarios

### Example 1: Verify the Existence of a Role with a Comment

**Command**:
```bash
sqitch verify create_app_role
```

**Generated SQL**:
```sql
/* Generated by: ~/.sqitch/templates/verify/create-role.tmpl */

-- Verify my_project:create_app_role on PostgreSQL

BEGIN;

-- Check if the role exists.
SELECT 1 / COUNT(*)
FROM pg_catalog.pg_roles
WHERE rolname = 'app_role';

-- Ensure the role has a comment provided.
SELECT 1 / COUNT(pg_catalog.shobj_description(pg_roles.oid, 'pg_authid'))
FROM pg_catalog.pg_roles
WHERE rolname = 'app_role';

COMMIT;
```

**Explanation**: This command verifies that the `app_role` role exists and has an associated comment in the database.

## Best Practices

- **Run Verification After Deployment**: Run the `verify` command after deploying a new role to confirm its creation and ensure documentation is present.
- **Error Handling**: The use of `1 / COUNT(*)` and `1 / COUNT(pg_catalog.shobj_description(...))` ensures that the command fails gracefully if the conditions are not met, highlighting missing roles or comments.

## Common Errors

- **Role Not Found**: If the role does not exist, the `SELECT 1 / COUNT(*)` query will fail due to a division by zero error, indicating that the verification did not pass.
- **Missing Comment**: If no comment is associated with the role, the `SELECT 1 / COUNT(pg_catalog.shobj_description(...))` query will fail with a division by zero error, signaling that the role lacks documentation.

## Conclusion

The **verify** template for `CREATE ROLE` ensures that roles are correctly created and documented in your PostgreSQL database. This verification helps maintain consistency and integrity in your **Sqitch** project by confirming that roles exist and are appropriately commented.
